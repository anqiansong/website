"use strict";(self.webpackChunkkeson_cn=self.webpackChunkkeson_cn||[]).push([[5456],{4137:function(e,n,t){t.d(n,{Zo:function(){return m},kt:function(){return f}});var r=t(7294);function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function a(e,n){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);n&&(r=r.filter((function(n){return Object.getOwnPropertyDescriptor(e,n).enumerable}))),t.push.apply(t,r)}return t}function o(e){for(var n=1;n<arguments.length;n++){var t=null!=arguments[n]?arguments[n]:{};n%2?a(Object(t),!0).forEach((function(n){l(e,n,t[n])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):a(Object(t)).forEach((function(n){Object.defineProperty(e,n,Object.getOwnPropertyDescriptor(t,n))}))}return e}function i(e,n){if(null==e)return{};var t,r,l=function(e,n){if(null==e)return{};var t,r,l={},a=Object.keys(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||(l[t]=e[t]);return l}(e,n);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(r=0;r<a.length;r++)t=a[r],n.indexOf(t)>=0||Object.prototype.propertyIsEnumerable.call(e,t)&&(l[t]=e[t])}return l}var c=r.createContext({}),u=function(e){var n=r.useContext(c),t=n;return e&&(t="function"==typeof e?e(n):o(o({},n),e)),t},m=function(e){var n=u(e.components);return r.createElement(c.Provider,{value:n},e.children)},s={inlineCode:"code",wrapper:function(e){var n=e.children;return r.createElement(r.Fragment,{},n)}},p=r.forwardRef((function(e,n){var t=e.components,l=e.mdxType,a=e.originalType,c=e.parentName,m=i(e,["components","mdxType","originalType","parentName"]),p=u(t),f=l,b=p["".concat(c,".").concat(f)]||p[f]||s[f]||a;return t?r.createElement(b,o(o({ref:n},m),{},{components:t})):r.createElement(b,o({ref:n},m))}));function f(e,n){var t=arguments,l=n&&n.mdxType;if("string"==typeof e||l){var a=t.length,o=new Array(a);o[0]=p;var i={};for(var c in n)hasOwnProperty.call(n,c)&&(i[c]=n[c]);i.originalType=e,i.mdxType="string"==typeof e?e:l,o[1]=i;for(var u=2;u<a;u++)o[u]=t[u];return r.createElement.apply(null,o)}return r.createElement.apply(null,t)}p.displayName="MDXCreateElement"},1536:function(e,n,t){t.r(n),t.d(n,{assets:function(){return m},contentTitle:function(){return c},default:function(){return f},frontMatter:function(){return i},metadata:function(){return u},toc:function(){return s}});var r=t(3117),l=t(102),a=(t(7294),t(4137)),o=["components"],i={title:"\u5de7\u5999\u4f7f\u7528channel\u5b9e\u73b0\u9650\u6d41\u5668",date:new Date("2020-05-10T00:00:00.000Z"),authors:"keson",tags:["go","limiter","\u9650\u6d41\u5668","channel"]},c=void 0,u={permalink:"/go/channel-limiter",source:"@site/blog/go/channel-limiter.md",title:"\u5de7\u5999\u4f7f\u7528channel\u5b9e\u73b0\u9650\u6d41\u5668",description:"cover",date:"2020-05-10T00:00:00.000Z",formattedDate:"2020\u5e745\u670810\u65e5",tags:[{label:"go",permalink:"/tags/go"},{label:"limiter",permalink:"/tags/limiter"},{label:"\u9650\u6d41\u5668",permalink:"/tags/\u9650\u6d41\u5668"},{label:"channel",permalink:"/tags/channel"}],readingTime:1.2033333333333334,truncated:!0,authors:[{name:"Keson",title:"\u5b57\u8282\u8df3\u52a8\u5f00\u53d1\u5de5\u7a0b\u5e08 /  goctl \u7ef4\u62a4\u4eba",url:"https://github.com/anqiansong",imageURL:"/img/logo.webp",key:"keson"}],frontMatter:{title:"\u5de7\u5999\u4f7f\u7528channel\u5b9e\u73b0\u9650\u6d41\u5668",date:"2020-05-10T00:00:00.000Z",authors:"keson",tags:["go","limiter","\u9650\u6d41\u5668","channel"]},prevItem:{title:"\u4e3a\u4ec0\u4e48\u770b\u4e86 N \u6b21 go module, \u5c31\u662f\u8bb0\u4e0d\u4f4f\uff1f",permalink:"/go/golang-module"}},m={authorsImageUrls:[void 0]},s=[{value:"\u666e\u901aLimiter",id:"\u666e\u901alimiter",level:3},{value:"\u4ee4\u724c\u6876Limiter",id:"\u4ee4\u724c\u6876limiter",level:3}],p={toc:s};function f(e){var n=e.components,i=(0,l.Z)(e,o);return(0,a.kt)("wrapper",(0,r.Z)({},p,i,{components:n,mdxType:"MDXLayout"}),(0,a.kt)("p",null,(0,a.kt)("img",{alt:"cover",src:t(3828).Z,width:"1200",height:"300"})),(0,a.kt)("h3",{id:"\u666e\u901alimiter"},"\u666e\u901aLimiter"),(0,a.kt)("p",null,"\u7279\u70b9\uff1a\u65e0\u65f6\u95f4\u9650\u5236\uff0c\u53ea\u8981\u4e0d\u8d85\u8fc7\u6570\u91cf\u5c31\u53ef\u901a\u8fc7"),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"// \u57fa\u4e8echannel\u963b\u585e\u5b9e\u73b0\n// \u7f3a\u70b9\uff1a\u963b\u585e\u65e0\u65f6\u95f4\u9650\u5236\ntype (\n    ChannelLimiter struct {\n        bufferChannel chan golang.PlaceholderType\n    }\n)\n\nfunc NewChannelLimiter(limit int) *ChannelLimiter {\n    return &ChannelLimiter{bufferChannel: make(chan golang.PlaceholderType, limit)}\n}\n\nfunc (l *ChannelLimiter) Allow() bool {\n    select {\n    case l.bufferChannel <- golang.Placeholder:\n        return true\n    default:\n        return false\n    }\n}\n\nfunc (l *ChannelLimiter) Release() bool {\n    <-l.bufferChannel\n    return true\n}\n\nfunc (l *ChannelLimiter) Close() {\n    close(l.bufferChannel)\n}\n\n")),(0,a.kt)("h3",{id:"\u4ee4\u724c\u6876limiter"},"\u4ee4\u724c\u6876Limiter"),(0,a.kt)("p",null,"\u7279\u70b9\uff1a",(0,a.kt)("a",{parentName:"p",href:"https://baike.baidu.com/item/%E4%BB%A4%E7%89%8C%E6%A1%B6%E7%AE%97%E6%B3%95/6597000?fr=aladdin"},"\u4ee4\u724c\u6876")),(0,a.kt)("pre",null,(0,a.kt)("code",{parentName:"pre",className:"language-go"},"// \u4ee4\u724c\u6876\u7b97\u6cd5\n// \u4ea7\u751f\u4ee4\u724c\uff1a\u5747\u4e3a\u95f4\u9694\u65f6\u95f4\u5185\uff081\u79d2\uff09\u5411\u6307\u5b9a\u6876\u4e2d\u4ea7\u751f\u6307\u5b9a\u6570\u91cf\u7684\u4ee4\u724c\n// \u6d88\u8d39\u4ee4\u724c\uff1a\u4ece\u6876\u4e2d\u83b7\u53d6\u4ee4\u724c\u5e76\u6d88\u8d39\n// \u601d\u8def\uff1a\u901a\u8fc7channel\u963b\u585e\u539f\u7406\u6765\u5b9e\u73b0\n\ntype (\n    TokenBucketLimiter struct {\n        t      *time.Ticker\n        bucket chan golang.PlaceholderType\n        doneC  channel.DoneChan\n        limit  int\n        rate   int\n        stop   func()\n    }\n)\n\n// rate\uff1atoken put rates per second\n// limit\uff1amax limit\nfunc NewTokenBucketLimiter(rate, limit int) *TokenBucketLimiter {\n    t := time.NewTicker(time.Second)\n    doneC := channel.NewDoneChan()\n    bucket := make(chan golang.PlaceholderType, limit)\n    tbl := &TokenBucketLimiter{\n        rate:   rate,\n        t:      t,\n        bucket: bucket,\n        doneC:  doneC,\n        limit:  limit,\n        // only stop once\n        stop: routine.DoOnce(func() {\n            doneC.Stop()\n            close(bucket)\n            t.Stop()\n        }),\n    }\n    // \u5b9a\u65f6\u653e\u7f6e\u4ee4\u724c\n    tbl.asyncPutTokens()\n    return tbl\n}\n\n// \u901a\u8fc7\u5c1d\u8bd5put golang.Placeholder \u6765\u8fbe\u5230\u662f\u5426\u6709\u4ee4\u724c\u53ef\u6d88\u8d39\nfunc (tbl *TokenBucketLimiter) Allow() bool {\n    select {\n    case tbl.bucket <- golang.Placeholder:\n        return true\n    case <-tbl.doneC.Done():\n        return false\n    default:\n        return false\n    }\n}\n\nfunc (tbl *TokenBucketLimiter) Close() {\n    tbl.stop()\n}\n\n// \u901a\u8fc7\u6392\u7a7achannel\u8fbe\u5230\u653e\u7f6etoken\u7684\u76ee\u7684\nfunc (tbl *TokenBucketLimiter) asyncPutTokens() {\n    safe.GoRun(func() {\n        for {\n            select {\n            case <-tbl.t.C:\n                tbl.drain()\n            case <-tbl.doneC.Done():\n                return\n            }\n        }\n    })\n}\n\nfunc (tbl *TokenBucketLimiter) drain() {\n    for i := 0; i < tbl.limit; i++ {\n        select {\n        case <-tbl.bucket:\n        default:\n            return\n        }\n    }\n}\n\n")))}f.isMDXComponent=!0},3828:function(e,n,t){n.Z=t.p+"assets/images/channel-limiter-2fa2d7ccbf92cbdcb998dd363017b153.png"}}]);